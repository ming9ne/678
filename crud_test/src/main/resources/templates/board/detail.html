<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/common :: head('detail.')">
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous"/>
    <link href="starter-template.css" rel="stylesheet"/>

    <title>detail</title>


</head>

<body>
<nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top" th:replace="fragments/common :: menu('home')"></nav>

<main role="main" class="container">
    <div class="starter-template">

        <table class ="table table-bordered"  style="margin-top: 100px;">
            <thead>
            <!-- <caption>글 읽기</caption> -->
            </thead>
            <tbody>
            <tr>
                <th>제목</th>
                <td th:text="${boardDto.title}"></td>
            </tr>
            <tbody>
            <tr>
                <th>작성자</th>
                <td th:text="${boardDto.writer}"></td>
            </tr>
            <tr>
                <th>작성일</th>
                <td th:inline="text">[[${#temporals.format(boardDto.createdAt, 'yyyy-MM-dd HH:mm')}]]</td>
            </tr>
            <tr>
                <th>본문 내용</th>
                <td th:text="${boardDto.content}"></td>
            </tr>
            </tbody>
        </table>

        <div class="btn-group">
            <a th:href="@{'/board/post/edit/' + ${boardDto.id}}" class="btn btn-primary">수정</a>
            <form id="delete-form" th:action="@{'/board/post/' + ${boardDto.id}}" method="post">
                <input type="hidden" name="_method" value="delete"/>
                <button class="btn btn-warning" id="delete-btn">삭제</button>
            </form>
            <a th:href="@{'/board/list'}" class="btn btn-primary">돌아가기</a>
        </div>
        <br>
        <hr>
        <br>
<!--         댓글 추가 부분-->
        <div class="card my-4">
            <h5 class="card-header">댓글을 입력해 주세요.</h5>
            <div class="card-body">
                <form th:action="@{'/comment/' + ${boardDto.id} + '/write'}" th:method="post">
                    <div class="form-group" style="margin-bottom: 10px;">
                        <input type="hidden" name="idx" th:value="*{idx}" />
                        <textarea name="content" class="form-control" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">등록</button>
                </form>
            </div>
        </div>

        <!-- Display Comments -->
        <div class="card my-4" th:if="${comments.size()} != 0">
            <h5 class="card-header">댓글:</h5>
            <div class="card-body">
                <div th:each="comment : ${comments}">
                    <div class="media mb-4">
                        <div class="media-body">
                            <h5 class="mt-0" th:text="${comment.user.nickname}">User Name</h5>
                            <p th:text="${comment.content}" th:id="'comment-' + ${comment.id}">Comment content</p>

                            <div th:if="${#authentication.name} == ${comment.user.username}">
                                <button type="button" class="btn btn-sm btn-outline-warning" th:attr="data-id=${comment.id}"
                                        onclick="edit(this);">수정</button>
                                <a th:href="@{'/comment/' + ${comment.id} + '/' + ${boardDto.id} + '/delete'}"
                                   class="btn btn-sm btn-outline-danger" onclick="return confirm('삭제하시겠습니까??')">삭제</a>
                            </div>
                        </div>
                    </div>
                    <hr>
                </div>
            </div>
        </div>


        <!-- 변수 셋팅 -->
        <script th:inline="javascript">
            /*<![CDATA[*/
            const boardDto = /*[[${boardDto}]]*/ "";
            const commentDto = /*[[${comments}]]*/ "";
            const user = /*[[${authUser}]]*/ "";
            const no = /*[[${no}]]*/ "";
            /*]]>*/
        </script>

        <!-- script -->
        <script th:inline="javascript" th:src="@{/js/board.js}"></script>

    </div>
</main>

<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script crossorigin="anonymous" src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script type="text/javascript">
    function edit(button) {
        console.log("editComment In!");
        const commentId = button.getAttribute('data-id');
        const commentElement = document.getElementById('comment-' + commentId);
        const commentContent = commentElement.textContent;

        const newContent = prompt('댓글 수정:', commentContent);

        $.ajax({
            type: "POST",
            url: "http://localhost:8080/comment/" + commentId + "/" + boardDto.id + "/update",
            data: {content: newContent},
            success: function (data) {
                console.log(data);
                history.go();
            },
            error: function () {
                alert("댓글 수정에 실패했습니다.");
            }
        });
    }
</script>
</body>
</html>